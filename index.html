<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIBBLE - The Daily Truth Game</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">

    <!-- Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fib-blue': '#1D4ED8', // Truth
                        'fib-red': '#B91C1C',  // Fib
                        'paper': '#F8FAFC',
                        'ink': '#0F172A',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f3f4f6;
            color: #111827;
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .anim-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center max-w-md mx-auto relative bg-gray-100 border-x border-gray-200">

    <!-- Header / Logo -->
    <header class="w-full pt-6 pb-4 px-4 bg-white border-b-2 border-black sticky top-0 z-20">
        <img src="https://i.ibb.co/67fj4TJP/Asset-1.png" alt="FIBBLE Logo" class="mx-auto max-w-[200px] md:max-w-[240px] block">
        <div class="text-center mt-2 text-xs font-sans text-gray-500 uppercase tracking-widest font-bold">
            ARE YOU PROPAGANDA BAIT?
        </div>
    </header>

    <!-- Loading State -->
    <div id="loading" class="flex-1 flex items-center justify-center flex-col p-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-black"></div>
        <p class="mt-4 font-serif text-lg">Loading the headlines...</p>
    </div>

    <!-- Game Container -->
    <main id="game-container" class="flex-1 w-full p-4 flex flex-col hidden">
        
        <!-- Progress Bar -->
        <div class="w-full bg-gray-300 h-2 rounded-full mb-6 overflow-hidden">
            <div id="progress-bar" class="bg-black h-full transition-all duration-300" style="width: 10%"></div>
        </div>

        <!-- Question Card -->
        <div class="bg-white border-2 border-black p-6 md:p-8 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] rounded-sm mb-6 flex-grow flex flex-col justify-center items-center text-center relative anim-pop">
            
            <!-- Category Badge (Hidden until answer) -->
            <div id="result-badge" class="hidden absolute -top-4 left-1/2 transform -translate-x-1/2 px-4 py-1 font-sans font-bold text-white uppercase tracking-widest text-sm rounded shadow-md z-10">
                Correct
            </div>

            <div class="w-full">
                <span id="question-label" class="font-sans text-gray-400 text-xs font-bold uppercase tracking-widest mb-2 block">Headline</span>
                <h2 id="question-text" class="font-serif text-2xl md:text-3xl font-bold leading-tight text-ink mb-4">
                    <!-- Text injected by JS -->
                </h2>
            </div>
            
            <!-- Context/Why (Hidden until answer) -->
            <div id="context-area" class="hidden mt-4 pt-4 border-t border-gray-200 w-full">
                <p class="font-sans text-sm font-bold text-gray-500 mb-1 uppercase tracking-tight">THE REALITY</p>
                <p id="context-text" class="font-sans text-base text-gray-800 leading-relaxed">
                    <!-- Context injected by JS -->
                </p>
            </div>
        </div>

        <!-- Controls -->
        <div id="controls-area" class="grid grid-cols-2 gap-4 mt-auto">
            <button onclick="handleGuess(true)" class="bg-fib-blue hover:bg-blue-800 text-white font-sans font-bold text-lg py-4 rounded shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-[2px] active:shadow-none transition-all">
                TRUTH
            </button>
            <button onclick="handleGuess(false)" class="bg-fib-red hover:bg-red-800 text-white font-sans font-bold text-lg py-4 rounded shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-[2px] active:shadow-none transition-all">
                FIB
            </button>
        </div>

        <!-- Next Button (Hidden initially) -->
        <div id="next-area" class="hidden mt-auto">
            <button onclick="nextQuestion()" class="w-full bg-black text-white font-sans font-bold text-lg py-4 rounded shadow-[2px_2px_0px_0px_rgba(100,100,100,1)] active:translate-y-[2px] active:shadow-none transition-all">
                NEXT HEADLINE &rarr;
            </button>
        </div>
    </main>

    <!-- Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm border-2 border-black p-6 rounded shadow-2xl text-center anim-pop">
            <h2 class="font-serif text-3xl font-bold mb-2">Today's Report</h2>
            <div id="final-date" class="font-sans text-gray-500 text-sm mb-4"></div>
            
            <div class="my-6">
                <div class="text-6xl font-bold font-serif mb-2" id="final-score">0/10</div>
                <div class="text-lg font-bold uppercase tracking-wide text-fib-blue" id="final-rank">Rank</div>
            </div>

            <div id="result-grid" class="flex justify-center gap-1 mb-6 flex-wrap max-w-[200px] mx-auto">
                <!-- Squares injected by JS -->
            </div>

            <!-- Countdown -->
            <div class="bg-gray-100 rounded p-3 mb-4">
                <p class="text-xs font-bold uppercase text-gray-500">Next Edition In</p>
                <p id="countdown" class="font-mono text-xl">00:00:00</p>
            </div>

            <div class="flex flex-col gap-2">
                <button onclick="shareResult()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded flex items-center justify-center gap-2 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                    SHARE SCORE
                </button>
                <button onclick="tryAgain()" class="w-full bg-white border-2 border-black text-black font-bold py-3 rounded hover:bg-gray-100 transition-colors">
                    TRY AGAIN
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-[60] font-sans text-sm font-bold">
        Result copied to clipboard!
    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT_YGbuJwfLzo9Vh1T_OwNKSZQ_Bs9XpSnJKL4Q2A_sLL-SXsRV8eIP80NXCXuKsKvZ1rCb6qrbt7QY/pub?output=csv';
        const TOTAL_QUESTIONS = 10;
        
        // --- STATE MANAGEMENT ---
        let gameState = {
            date: null,
            index: 0,
            score: 0,
            history: [], // Stores 'correct' or 'wrong' for each q
            completed: false,
            questions: [] // The 10 questions for today
        };

        // --- SEEDED RANDOM NUMBER GENERATOR (Mulberry32) ---
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            }
        }

        function cyrb128(str) {
            let h1 = 1779033703, h2 = 3144134277,
                h3 = 1013904242, h4 = 2773480762;
            for (let i = 0, k; i < str.length; i++) {
                k = str.charCodeAt(i);
                h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
                h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
                h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
                h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
            }
            h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
            h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
            h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
            h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
            return (h1^h2^h3^h4) >>> 0;
        }

        // --- CSV PARSER ---
        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentCell += '"'; 
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\r' || char === '\n') && !inQuotes) {
                    if (currentCell || currentRow.length > 0) {
                        currentRow.push(currentCell.trim());
                        rows.push(currentRow);
                        currentRow = [];
                        currentCell = '';
                    }
                } else {
                    currentCell += char;
                }
            }
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }
            return rows;
        }

        // --- INIT & LOGIC ---

        async function initGame() {
            const todayStr = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD
            
            const savedData = localStorage.getItem('fibble_state');
            
            if (savedData) {
                const parsed = JSON.parse(savedData);
                if (parsed.date === todayStr) {
                    gameState = parsed;
                } else {
                    resetGameState(todayStr);
                }
            } else {
                resetGameState(todayStr);
            }

            try {
                const response = await fetch(SHEET_CSV_URL);
                if (!response.ok) throw new Error("Network error");
                const text = await response.text();
                const rawRows = parseCSV(text);
                
                // Process Rows: Filter empty and headers
                let cleanRows = rawRows.slice(1).filter(r => r.length >= 2 && r[0] !== "");

                // Ensure unique headlines only
                const seenHeadlines = new Set();
                cleanRows = cleanRows.filter(row => {
                    const headline = row[0].toLowerCase().trim();
                    if (seenHeadlines.has(headline)) return false;
                    seenHeadlines.add(headline);
                    return true;
                });

                // Seeded Shuffle
                const seedVal = cyrb128(todayStr);
                const rng = mulberry32(seedVal);

                for (let i = cleanRows.length - 1; i > 0; i--) {
                    const j = Math.floor(rng() * (i + 1));
                    [cleanRows[i], cleanRows[j]] = [cleanRows[j], cleanRows[i]];
                }

                // If we already had questions, don't overwrite
                if (!gameState.questions || gameState.questions.length === 0) {
                    gameState.questions = cleanRows.slice(0, TOTAL_QUESTIONS);
                }
                
                saveState();

                document.getElementById('loading').classList.add('hidden');
                
                if (gameState.completed) {
                    showSummary();
                } else {
                    document.getElementById('game-container').classList.remove('hidden');
                    renderCurrentQuestion();
                }

            } catch (e) {
                document.getElementById('loading').innerHTML = `<p class="text-red-600 font-bold">Error loading game data.<br>Please refresh.</p>`;
                console.error(e);
            }
        }

        function resetGameState(dateStr) {
            gameState.date = dateStr;
            gameState.index = 0;
            gameState.score = 0;
            gameState.history = [];
            gameState.completed = false;
            gameState.questions = [];
        }

        function renderCurrentQuestion() {
            if (gameState.index >= TOTAL_QUESTIONS) {
                showSummary();
                return;
            }

            const q = gameState.questions[gameState.index];
            const category = q[1].toLowerCase();
            const labelEl = document.getElementById('question-label');
            
            // Dynamic Labeling logic
            if (category.includes('news')) {
                labelEl.innerText = "HEADLINE";
            } else {
                labelEl.innerText = "FACT";
            }
            
            document.getElementById('question-text').innerText = q[0];
            document.getElementById('context-text').innerText = q[2] || "Check trusted sources for more context.";

            document.getElementById('result-badge').classList.add('hidden');
            document.getElementById('context-area').classList.add('hidden');
            document.getElementById('controls-area').classList.remove('hidden');
            document.getElementById('next-area').classList.add('hidden');

            const pct = ((gameState.index) / TOTAL_QUESTIONS) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }

        function handleGuess(userSaidTruth) {
            const currentQ = gameState.questions[gameState.index];
            const category = currentQ[1].toLowerCase();
            
            const isActuallyTruth = category.includes("real");
            const isCorrect = (userSaidTruth && isActuallyTruth) || (!userSaidTruth && !isActuallyTruth);

            if (isCorrect) gameState.score++;
            gameState.history.push(isCorrect ? 'correct' : 'wrong');
            
            const badge = document.getElementById('result-badge');
            badge.innerText = isCorrect ? "CORRECT" : "WRONG";
            badge.className = `absolute -top-4 left-1/2 transform -translate-x-1/2 px-4 py-1 font-sans font-bold text-white uppercase tracking-widest text-sm rounded shadow-md z-10 ${isCorrect ? 'bg-fib-blue' : 'bg-fib-red'}`;
            badge.classList.remove('hidden');

            document.getElementById('context-area').classList.remove('hidden');
            document.getElementById('controls-area').classList.add('hidden');
            document.getElementById('next-area').classList.remove('hidden');
            
            saveState();
        }

        function nextQuestion() {
            gameState.index++;
            saveState();
            renderCurrentQuestion();
        }

        function tryAgain() {
            localStorage.removeItem('fibble_state');
            location.reload();
        }

        function saveState() {
            localStorage.setItem('fibble_state', JSON.stringify(gameState));
        }

        function getRankTitle(score) {
            if (score === 10) return "Newsroom Veteran ðŸ†";
            if (score >= 8) return "Skeptical Citizen ðŸ§";
            if (score >= 6) return "General Population ðŸ˜";
            if (score >= 4) return "Propaganda Fodder ðŸ˜µâ€ðŸ’«";
            return "Bot Farm's Best Friend ðŸ¤–";
        }

        function showSummary() {
            gameState.completed = true;
            saveState();

            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('summary-modal').classList.remove('hidden');

            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('final-date').innerText = today.toLocaleDateString('en-US', options);
            document.getElementById('final-score').innerText = `${gameState.score}/${TOTAL_QUESTIONS}`;
            document.getElementById('final-rank').innerText = getRankTitle(gameState.score);

            const gridContainer = document.getElementById('result-grid');
            gridContainer.innerHTML = '';
            gameState.history.forEach(res => {
                const span = document.createElement('span');
                span.className = 'w-6 h-6 rounded-sm block';
                span.style.backgroundColor = res === 'correct' ? '#1D4ED8' : '#B91C1C';
                gridContainer.appendChild(span);
            });

            startCountdown();
        }

        function startCountdown() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            setInterval(() => {
                const diff = tomorrow - new Date();
                if (diff <= 0) {
                    location.reload();
                    return;
                }
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('countdown').innerText = 
                    `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }, 1000);
        }

        function shareResult() {
            let grid = "";
            gameState.history.forEach((res, i) => {
                grid += res === 'correct' ? 'ðŸŸ¦' : 'ðŸŸ¥';
                if (i === 4) grid += "\n";
            });

            const text = `FIBBLE ${new Date().toLocaleDateString()}
Score: ${gameState.score}/10
${getRankTitle(gameState.score)}

${grid}

Play now: ${window.location.href}`;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(showToast);
            } else {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast();
            }
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.style.opacity = '1';
            setTimeout(() => { t.style.opacity = '0'; }, 2000);
        }

        initGame();
    </script>
</body>
</html>
